<%
  # ÂàùÂßãÂåñÊâÄÊúâÂèòÈáè
  table_width_ratio = 1.0 # Ë°®Ê†ºÂÆΩÂ∫¶ÊåâÊØî‰æãË∞ÉÊï¥
  n = 1 # Êï∞ÊçÆÈõÜÁ¥¢ÂºïÂàùÂßãÂÄº
  amount_pos = 8 # ÈªòËÆ§ÁöÑ‰ª•Â§™ÂùäÊÄªÂíåÊòæÁ§∫‰ΩçÊï∞
  total_price = total_amount = total_fees = total_get_usdt = total_cny_amount = \
  total_cny_amount_now = total_earn_or_loss = 0.0

  # ÊØîÁâπÂ∏ÅÁé∞‰ª∑
  btc_now = get_btc_price
  # ‰ª•Â§™ÂùäÁé∞‰ª∑
  eth_now = get_eth_price
  # ‰ª•Â§™ÂùäÂÖëÊØîÁâπÂ∏ÅÁé∞‰ª∑
  eth_btc_now = btc_now > 0 ? eth_now/btc_now : 0
  # ÁãóÁãóÂ∏ÅÁé∞‰ª∑
  doge_now = get_doge_price
  # ‰∫§ÊòìÊâÄÂÜÖÂâ©‰ΩôÁöÑ‰ª•Â§™Âùä
  @eth_amount_ex = DealRecord.eth_amount
  # ÂéüÊúâÂèÇ‰∏éÂçñÂá∫ÁöÑ‰ª•Â§™Âùä
  @ori_eth_amount = get_invest_params(3,'ETH').to_f
  # ‰øùÁïôÂ§öÂ∞ë‰ª•Â§™‰ªì‰Ωç‰∏çÂçñ
  @keep_eth_level = get_invest_params(29,'ETH').to_i
  # ÂçñÂá∫ÊúÄÈ´ò‰ª∑Êó∂ÁöÑÊúÄ‰Ωé‰ª∑
  @min_price_when_sell = get_invest_params(38,'ETH').to_f
  # ÁõÆÊ†áÂ∏ÅÁßç
  @target_bi = eth2bi
  price_pos = @target_bi == 'btc' ? 6 : 2 # ‰ª∑Ê†ºÊòæÁ§∫ÁöÑÂ∞èÊï∞ÁÇπ‰ΩçÊï∞
  get_pos = @target_bi == 'btc' ? 8 : 4 # ÂÆûÂæóÂ∏ÅÊï∞ÊòæÁ§∫ÁöÑÂ∞èÊï∞ÁÇπ‰ΩçÊï∞
  # ÊòæÁ§∫‰ª•Â§™ÂùäÂâ©‰Ωô‰ªì‰ΩçÁä∂ÊÄÅ
  def show_eth_level_status
    eth_level = @ori_eth_amount > 0 ? (@eth_amount_ex/@ori_eth_amount*100).to_i : 0
    raw "<span title='#{get_huobi_acc_id}‰∫§ÊòìÊâÄÂÜÖ‰ª•Â§™ÂùäÂâ©‰Ωô‰ªì‰Ωç'>#{eth_level}</span>/<span title='‰øùÁïôÂ§öÂ∞ë‰ª•Â§™‰ªì‰Ωç‰∏çÂçñ'>#{@keep_eth_level}</span>"
  end

  # ÊòæÁ§∫ÂΩìÂâçÁöÑÂçñÂá∫Á≠ñÁï•
  def show_sell_strategy
    code = "SETH"
    every_minute = get_invest_params(22,code).to_i/60
    sell_over_price = get_invest_params(27,code).to_i
    sell_when_minutes = get_invest_params(18,code).to_i
    sell_cny = get_invest_params(39,code).to_i
    result = ">=#{sell_over_price}|ÊØè#{every_minute}ÂàÜ|¬•#{sell_cny}" if sell_over_price > 0
    result = "#{sell_when_minutes}È´ò|ÊØè#{every_minute}ÂàÜ|¬•#{sell_cny}" if sell_when_minutes > 0
    result = "<u>#{result}</u>" if DealRecord.enable_to_sell? code
    return raw(result)
  end

  # ÂàóË°®ÁßçÁ±ªÂèÇÊï∞
  def list_page_params
    {
      show_all: params[:show_all], show_sell: params[:show_sell], \
      show_unsell: params[:show_unsell], make_balance_count: params[:make_balance_count], \
      make_trezor_count: params[:make_trezor_count], show_first: params[:show_first], \
      show_balance: params[:show_balance], show_trezor: params[:show_trezor]
    }
  end

  # Â§öÁßçÂàóË°®ËÉΩÈÄâÊã©ÊåâÁÖß‰∏ãÂçïÊó∂Èó¥Êàê‰∫§‰ª∑Êàê‰∫§ÈáèÊéíÂ∫è
  def order_list_params( field_name )
    { order_field: field_name }.merge list_page_params
  end

  # ÁÇπÂáªËΩ¨Âá∫ÂêéÂºÄÂêØÊñ∞ËßÜÁ™ó
  def build_switch_params( action, id )
      { action: action, id: id }.merge list_page_params
  end

  # ‰∫§ÊòìÊâÄETH‰ΩôÈ¢ùÁ≠â‰∫éÂ§öÂ∞ë‰∫∫Ê∞ëÂ∏Å
  def ex_remain_cny
    (@eth_amount_ex*get_eth_price*$usdt_to_cny).to_i
  end

  # ÊòØÂê¶‰∏∫BTCÊä•‰ª∑
  def btc?
    @target_bi == 'btc' ? true : false
  end

%>
<table width="<%=$default_table_width*table_width_ratio%>" style="font-size:<%=$deal_record_font_size%>">
  <tr class="thead">
    <td width="15"><%= link_to 'üè†', set_eth_as_home_path %></td>
    <td width="300">
      <% # ÊòæÁ§∫ÂçñÂá∫Êù°‰ª∂ %>
      <%= set_auto_invest_form_link("SETH","ÂçñÂá∫Êù°‰ª∂") %>: <%= show_sell_strategy %> | ÊúÄ‰ΩéÂçñ‰ª∑: <%= @min_price_when_sell %>
    </td>
    <td>
      <% # Êàê‰∫§‰ª∑ %>
      <%= link_to t(:deal_record_price), order_list_params('price') %>
    </td>
    <td>
      <% # Êàê‰∫§Èáè %>
      <%= link_to t(:deal_record_amount)+'(ETH)', order_list_params('amount') %>
    </td>
    <td>ÊâãÁª≠Ë¥π(<%=@target_bi.upcase%>)</td>
    <td>ÂÆûÂæóÂ∏Å(<%=@target_bi.upcase%>)</td>
    <td>RMB</td>
    <td>Êó∂Èó¥</td>
    <td>
      <% # ËµÑ‰∫ßÂáÄÂÄºÂèòÂåñÂÄº %>
      <%= show_net_value_change_text %>
    </td>
  </tr>
<% @eth_deal_records.each do |dr| %>
  <tr <%= change_row_color %>>
    <td align="right">
      <% # ÊòæÁ§∫‰ºòÂçñÂäüËÉΩÈìæÊé• %>
      <span <%= raw "class='switch_first_sell'" if dr.first_sell %>>
        <%= link_to n, build_switch_params(:switch_first_sell, dr) %>
      </span>
    </td>
    <td align="center">
      <% # ÊòæÁ§∫‰∏ãÂçïÊó∂Èó¥ %>
      <%= link_edit_to(dr,to_t(dr.created_at,true)) %>
    </td>
    <td align="right">
      <% # Êàê‰∫§‰ª∑ %>
      <%= price = to_n(dr.price,price_pos) %>
    </td>
    <td align="right">
      <% # Êàê‰∫§Èáè %>
      <% amount_fee = to_n(dr.amount-dr.fees,amount_pos) %>
      <%= amount = to_n(dr.amount,amount_pos) %>
    </td>
    <% # ÊâãÁª≠Ë¥π %>
    <td align="right"><%= to_n(dr.fees,amount_pos) %></td>
    <% # ÂÆûÂæóÂ∏Å %>
    <td align="right"><%= get_usdt = to_n(dr.price*dr.amount-dr.fees,get_pos) %></td>
    <td align="right">
      <% # ÂÄº‰∫∫Ê∞ëÂ∏Å %>
      <%= cny_amount = to_n(dr.cny_amount(btc?),1) %>
    </td>
    <td align="right">
      <% # Êõ¥Êñ∞Êó∂Èó¥ %>
      <%= updated_at_str = to_time(dr.updated_at) %>
    </td>
    <td align="right">
      <%= link_to 'ÂçïÁ¨îÂà†Èô§', delete_eth_deal_record_path(id:dr.id) %>
    | <%= link_to 'ÂÖ®ÈÉ®Âà†Èô§', clear_eth_deal_records_path %>
    <% if @target_bi == "usdt" %>
      | <%= link_to 'Âà†ÂêéÂä†Â∏Å', delete_eth_deal_record_then_add_usdt_path(id:dr.id) %>
      | <%= link_to 'ÂÖ®Âà†Âä†Â∏Å', clear_eths_deal_record_then_add_usdt_path %>
    <% end %>
    </td>
  </tr>
  <%
    # Ê±ÇÂíå‰ª•ÊòæÁ§∫Êï∞ÊçÆÂä†ÊÄªÊàñÊ±ÇÂπ≥Âùá
    n += 1
    total_price += price.to_f * amount.to_f
    total_amount += amount.to_f
    total_fees += dr.fees
    total_get_usdt += get_usdt.to_f
    total_cny_amount += cny_amount.to_f
  end # ÁªìÊùü @deal_records.each
  # Êàê‰∫§Âùá‰ª∑
  @total_ave_cost_price = total_amount > 0 ? (total_price/total_amount).floor(4) : ''
%>
  <tr class="thead">
    <td colspan="2">
      <% # ÊòæÁ§∫Áé∞‰ª∑‰∏ékÁ∫øÂõæÈìæÊé• %>
      <%= show_prices_and_chart_links %>
    </td>
    <td align="right">
      <% # ÊòæÁ§∫Êàê‰∫§Âùá‰ª∑ %>
      <%= to_n(@total_ave_cost_price.to_f,6) %>
    </td>
    <% a_pos = 6 %>
    <td align="right">
      <% # Êàê‰∫§ÈáèÊÄªÂíå %>
      <%= to_n(total_amount,a_pos) %>
    </td>
    <td align="right">
      <% # ÊâãÁª≠Ë¥πÊÄªÂíå %>
      <%= to_n(total_fees,a_pos) %>
    </td>
    <td align="right">
      <% # ÂÆûÂæóÂ∏ÅÊÄªÂíå %>
      <%= to_n(total_get_usdt,a_pos) %>
    </td>
    <td align="right">
      <% # ÂÄº‰∫∫Ê∞ëÂ∏ÅÊÄªÂíå %>
      <%= to_n(total_cny_amount,1) %>
    </td>
    <td align="right" colspan="2">
      <% # ÊòæÁ§∫‰∫§ÊòìÊâÄETH‰ΩôÈ¢ù %>
      <span title="<%=get_huobi_acc_id%>‰∫§ÊòìÊâÄETH‰ΩôÈ¢ù"><%= to_n(@eth_amount_ex,8) %></span>(¬•<%=ex_remain_cny%>ÂèØÂçñ|<%=show_eth_level_status%>) |
      <% # ÊòæÁ§∫ËµÑ‰∫ßÂáÄÂÄº‰∏éËµ∞ÂäøÂõæÈìæÊé• %>
      <%= show_net_value_link %>
    </td>
  </tr>
</table>
