<%
  # ÂàùÂßãÂåñÊâÄÊúâÂèòÈáè
  table_width_ratio = 1.0 # Ë°®Ê†ºÂÆΩÂ∫¶ÊåâÊØî‰æãË∞ÉÊï¥
  n = 1 # Êï∞ÊçÆÈõÜÁ¥¢ÂºïÂàùÂßãÂÄº
  amount_pos = 8 # ÈªòËÆ§ÁöÑ‰ª•Â§™ÂùäÊÄªÂíåÊòæÁ§∫‰ΩçÊï∞
  total_price = total_amount = total_fees = total_get_usdt = total_cny_amount = \
  total_cny_amount_now = total_earn_or_loss = 0.0
  get_code = 'BTC'
  # ÊØîÁâπÂ∏ÅÁé∞‰ª∑
  btc_now = get_btc_price
  # ‰ª•Â§™ÂùäÁé∞‰ª∑
  eth_now = get_eth_price
  # ‰∫§ÊòìÊâÄÂÜÖÂâ©‰ΩôÁöÑBTC
  @btc_amount_ex = DealRecord.btc_amount
  # ÂéüÊúâÂèÇ‰∏éÂçñÂá∫ÁöÑBTC
  @ori_btc_amount = get_invest_params(23,get_code).to_f
  # ‰øùÁïôÂ§öÂ∞ëBTC‰ªì‰Ωç‰∏çÂçñ
  @keep_btc_level = get_invest_params(29,get_code).to_i
  # ÂçñÂá∫ÊúÄÈ´ò‰ª∑Êó∂ÁöÑÊúÄ‰Ωé‰ª∑
  @min_price_when_sell = get_invest_params(38,get_code).to_f
  # ÁõÆÊ†áÂ∏ÅÁßç
  @target_bi = 'usdt'
  price_pos = 2 # ‰ª∑Ê†ºÊòæÁ§∫ÁöÑÂ∞èÊï∞ÁÇπ‰ΩçÊï∞
  get_pos = 4 # ÂÆûÂæóÂ∏ÅÊï∞ÊòæÁ§∫ÁöÑÂ∞èÊï∞ÁÇπ‰ΩçÊï∞
  # ÊòæÁ§∫BTCÂâ©‰Ωô‰ªì‰ΩçÁä∂ÊÄÅ
  def show_btc_level_status
    level = @ori_btc_amount > 0 ? (@btc_amount_ex/@ori_btc_amount*100).to_i : 0
    raw "<span title='#{get_huobi_acc_id}‰∫§ÊòìÊâÄÂÜÖBTCÂâ©‰Ωô‰ªì‰Ωç'>#{level}</span>/<span title='‰øùÁïôÂ§öÂ∞ëBTC‰ªì‰Ωç‰∏çÂçñ'>#{@keep_btc_level}</span>"
  end

  # ÊòæÁ§∫ÂΩìÂâçÁöÑÂçñÂá∫Á≠ñÁï•
  def show_sell_strategy
    code = "BTC"
    every_minute = get_invest_params(22,code).to_i/60
    sell_over_price = get_invest_params(27,code).to_i
    sell_when_minutes = get_invest_params(18,code).to_i
    sell_cny = get_invest_params(39,code).to_i
    result = ">=#{sell_over_price}|ÊØè#{every_minute}ÂàÜ|¬•#{sell_cny}" if sell_over_price > 0
    result = "#{sell_when_minutes}È´ò|ÊØè#{every_minute}ÂàÜ|¬•#{sell_cny}" if sell_when_minutes > 0
    result = "<u>#{result}</u>" if DealRecord.enable_to_sell? code
    return raw(result)
  end

  # ÂàóË°®ÁßçÁ±ªÂèÇÊï∞
  def list_page_params
    {
      show_all: params[:show_all], show_sell: params[:show_sell], \
      show_unsell: params[:show_unsell], make_balance_count: params[:make_balance_count], \
      make_trezor_count: params[:make_trezor_count], show_first: params[:show_first], \
      show_balance: params[:show_balance], show_trezor: params[:show_trezor]
    }
  end

  # Â§öÁßçÂàóË°®ËÉΩÈÄâÊã©ÊåâÁÖß‰∏ãÂçïÊó∂Èó¥Êàê‰∫§‰ª∑Êàê‰∫§ÈáèÊéíÂ∫è
  def order_list_params( field_name )
    { order_field: field_name }.merge list_page_params
  end

  # ÁÇπÂáªËΩ¨Âá∫ÂêéÂºÄÂêØÊñ∞ËßÜÁ™ó
  def build_switch_params( action, id )
      { action: action, id: id }.merge list_page_params
  end

  # ‰∫§ÊòìÊâÄBTC‰ΩôÈ¢ùÁ≠â‰∫éÂ§öÂ∞ë‰∫∫Ê∞ëÂ∏Å
  def ex_remain_cny
    (@btc_amount_ex*get_btc_price*$usdt_to_cny).to_i
  end

  # ÊòØÂê¶‰∏∫BTCÊä•‰ª∑
  def btc?
    @target_bi == 'btc' ? true : false
  end

%>
<table width="<%=$default_table_width*table_width_ratio%>">
  <tr class="thead">
    <td width="15"><%= link_to 'üè†', set_sbtc_as_home_path %></td>
    <td width="320">
      <% # ‰∏ãÂçïÊó∂Èó¥ %>
      <%= link_to t(:deal_record_created), order_list_params('created_at') %>
      |
      <% # ÊòæÁ§∫Áé∞‰ª∑‰∏ékÁ∫øÂõæÈìæÊé• %>
      <%= kline_chart_link(to_n(btc_now,2)) %> | <%= kline_chart_link to_n(@eth_price), "ethusdt" %> | <%= kline_chart_link to_n(@ethbtc_price,6), "ethbtc" %>
    </td>
    <td>
      <% # Êàê‰∫§‰ª∑ %>
      <%= link_to t(:deal_record_price), order_list_params('price') %>
    </td>
    <td>
      <% # Êàê‰∫§Èáè %>
      <%= link_to t(:deal_record_amount)+'(BTC)', order_list_params('amount') %>
    </td>
    <td>ÊâãÁª≠Ë¥π(U)</td>
    <td>ÂÆûÂæóÂ∏Å(U)</td>
    <td>RMB</td>
    <td>
      <% # Êõ¥Êñ∞Êó∂Èó¥ %>
      <%= "Êõ¥Êñ∞Êó∂Èó¥" %>
    </td>
    <td>
      <% # ËµÑ‰∫ßÂáÄÂÄºÂèòÂåñÂÄº %>
      <%= show_net_value_change_text %>
    </td>
  </tr>
<% @btc_deal_records.each do |dr| %>
  <tr <%= change_row_color %>>
    <td align="right">
      <% # ÊòæÁ§∫‰ºòÂçñÂäüËÉΩÈìæÊé• %>
      <span <%= raw "class='switch_first_sell'" if dr.first_sell %>>
        <%= link_to n, build_switch_params(:switch_first_sell, dr) %>
      </span>
    </td>
    <td align="center">
      <% # ÊòæÁ§∫‰∏ãÂçïÊó∂Èó¥ %>
      <%= link_edit_to(dr,to_t(dr.created_at,true)) %>
    </td>
    <td align="right">
      <% # Êàê‰∫§‰ª∑ %>
      <%= price = to_n(dr.price,price_pos) %>
    </td>
    <td align="right">
      <% # Êàê‰∫§Èáè %>
      <% amount_fee = to_n(dr.amount-dr.fees,amount_pos) %>
      <%= amount = to_n(dr.amount,amount_pos) %>
    </td>
    <% # ÊâãÁª≠Ë¥π %>
    <td align="right"><%= to_n(dr.fees,amount_pos) %></td>
    <% # ÂÆûÂæóÂ∏Å %>
    <td align="right"><%= get_usdt = to_n(dr.price*dr.amount-dr.fees,get_pos) %></td>
    <td align="right">
      <% # ÂÄº‰∫∫Ê∞ëÂ∏Å %>
      <%= cny_amount = to_n(dr.cny_amount(btc?),1) %>
    </td>
    <td align="right">
      <% # Êõ¥Êñ∞Êó∂Èó¥ %>
      <%= updated_at_str = to_time(dr.updated_at) %>
    </td>
    <td align="right">
      <%= link_to 'ÂçïÁ¨îÂà†Èô§', delete_btc_deal_record_path(id:dr.id) %>
    | <%= link_to 'ÂÖ®ÈÉ®Âà†Èô§', clear_btc_deal_records_path %>
    </td>
  </tr>
  <%
    # Ê±ÇÂíå‰ª•ÊòæÁ§∫Êï∞ÊçÆÂä†ÊÄªÊàñÊ±ÇÂπ≥Âùá
    n += 1
    total_price += price.to_f * amount.to_f
    total_amount += amount.to_f
    total_fees += dr.fees
    total_get_usdt += get_usdt.to_f
    total_cny_amount += cny_amount.to_f
  end # ÁªìÊùü @deal_records.each
  # Êàê‰∫§Âùá‰ª∑
  @total_ave_cost_price = total_amount > 0 ? (total_price/total_amount).floor(4) : ''
%>
  <tr class="thead">
    <td colspan="2">
      ÂçñÂá∫Êù°‰ª∂: <%= show_sell_strategy %>
       | ÊúÄ‰ΩéÂçñ‰ª∑: <%= @min_price_when_sell %>
    </td>
    <td align="right">
      <% # ÊòæÁ§∫Êàê‰∫§Âùá‰ª∑ %>
      <%= to_n(@total_ave_cost_price.to_f,6) %>
    </td>
    <% a_pos = 6 %>
    <td align="right">
      <% # Êàê‰∫§ÈáèÊÄªÂíå %>
      <%= to_n(total_amount,a_pos) %>
    </td>
    <td align="right">
      <% # ÊâãÁª≠Ë¥πÊÄªÂíå %>
      <%= to_n(total_fees,a_pos) %>
    </td>
    <td align="right">
      <% # ÂÆûÂæóÂ∏ÅÊÄªÂíå %>
      <%= to_n(total_get_usdt,a_pos) %>
    </td>
    <td align="right">
      <% # ÂÄº‰∫∫Ê∞ëÂ∏ÅÊÄªÂíå %>
      <%= to_n(total_cny_amount,1) %>
    </td>
    <td align="right" colspan="2">
      <% # ÊòæÁ§∫‰∫§ÊòìÊâÄBTC‰ΩôÈ¢ù %>
      <span title="<%=get_huobi_acc_id%>‰∫§ÊòìÊâÄBTC‰ΩôÈ¢ù">BTC: <%= to_n(@btc_amount_ex,8) %></span>(¬•<%=ex_remain_cny%>ÂèØÂçñ|<%=show_btc_level_status%>) |
      <% # ÊòæÁ§∫ËµÑ‰∫ßÂáÄÂÄº‰∏éËµ∞ÂäøÂõæÈìæÊé• %>
      <%= show_net_value_link %>
    </td>
  </tr>
</table>
