<%
  # åˆå§‹åŒ–æ‰€æœ‰å˜é‡
  @code = 'MANA'
  n = 1 # æ•°æ®é›†ç´¢å¼•åˆå§‹å€¼
  amount_pos = 6 # é»˜è®¤çš„CRYPTOæ€»å’Œæ˜¾ç¤ºä½æ•°
  total_price = total_amount = total_amount_fee = total_cny_amount = \
  total_cny_amount_now = total_earn_or_loss = total_real_profit = \
  total_real_profit_crypto = max_buy_price = 0

  # CRYPTOç°ä»·
  crypto_now = get_crypto_price(@code)
  # åŸæœ‰å‚ä¸æŠ•èµ„çš„æ³°è¾¾å¸
  @ori_usdt = get_invest_params(3,@code).to_f
  # è‡ªåŠ¨ä¹°å…¥çš„æœ€å¤§ä»“ä½å€¼
  @max_buy_level = get_invest_params(5,@code).to_f
  # äº¤æ˜“æ‰€å†…å‰©ä½™çš„CRYPTO
  @crypto_amount_ex = DealRecord.crypto_amount(@code)
  # ç›®å‰çš„ä»“ä½å€¼
  @crypto_level = DealRecord.crypto_level(@code)
  # è‡ªåŠ¨ä¹°å…¥çš„æœ€å¤§ä»“ä½å€¼åˆäººæ°‘å¸
  @max_buy_cny = @ori_usdt*@max_buy_level/100*$usdt_to_cny
  @max_buy_cny_remain = @max_buy_cny - @ori_usdt*@crypto_level/100*$usdt_to_cny
  # äº¤æ˜“æ‰€å†…å‰©ä½™çš„æ³°è¾¾å¸çš„äººæ°‘å¸ä»·å€¼
  @usdt2cny_ex = DealRecord.usdt_amount*$usdt_to_cny
  # äººæ°‘å¸å…‘æ¢CRYPTO
  cny_to_crypto = Currency.new.cny_to_crypto(@code)
  # ä¸‹ä¸€ç¬”è¦å–å‡ºçš„CRYPTOæ•°é‡
  next_sell_amount = DealRecord.top_n_profit(@get_max_sell_count,:amount_fees)
  # æœ€è¿‘å‡ å°æ—¶å†…çš„ç´¯è®¡è·åˆ©
  real_profit_of_24h = DealRecord.real_profit_of_24h($send_to_trezor_time).to_i
  # æ€»ç´¯è®¡è·åˆ©
  total_real_profit = DealRecord.total_real_profit.to_i
  # å¹³å‡æ¯ç§’çš„å·²å®ç°æŸç›Šå€¼
  real_p_sec = DealRecord.real_profit_ave_sec($send_to_trezor_time)
  # æ˜¯å¦å·²ç»è¾¾åˆ°å¯ä»¥å†æ¬¡ä¹°å…¥çš„æ—¶é—´
  enable_to_buy = DealRecord.enable_to_buy?

  # æœ‰ä¼ å…¥ä»¥ä¸‹å‚æ•°è€…æ˜¾ç¤ºæ‰€æœ‰è®°å½•
  def show_all_records_conditions
    params[:show_all] or params[:show_sell] or params[:show_unsell] or \
    params[:show_first] or params[:show_trezor] or params[:make_balance_count] or \
    params[:make_trezor_count] or params[:show_balance]
  end

  # æœ‰ä¼ å…¥ä»¥ä¸‹å‚æ•°è€…æ˜¾ç¤º8ä½çš„CRYPTOæ•°é‡
  def show_long_crypto_amount
    params[:make_trezor_count] or params[:show_trezor] or params[:show_unsell] or \
    params[:make_balance_count] or params[:show_balance]
  end

  # ç°ä»·æ ä½æ˜¯å¦æŒ‰ç…§CRYPTOç°ä»·æ¥æ‰§è¡Œè®¡ç®—
  def cal_with_crypto_now?( dr )
    !dr.real_profit or dr.real_profit == 0
  end

  # åˆ—è¡¨ç§ç±»å‚æ•°
  def list_page_params
    {
      show_all: params[:show_all], show_sell: params[:show_sell], \
      show_unsell: params[:show_unsell], make_balance_count: params[:make_balance_count], \
      make_trezor_count: params[:make_trezor_count], show_first: params[:show_first], \
      show_balance: params[:show_balance], show_trezor: params[:show_trezor]
    }
  end

  # å¤šç§åˆ—è¡¨èƒ½é€‰æ‹©æŒ‰ç…§ä¸‹å•æ—¶é—´æˆäº¤ä»·æˆäº¤é‡æ’åº
  def order_list_params( field_name )
    { order_field: field_name }.merge list_page_params
  end

  # ç‚¹å‡»è½¬å‡ºåå¼€å¯æ–°è§†çª—
  def build_switch_params( action, id )
      { action: action, id: id }.merge list_page_params
  end

  # è‹¥æœ‰è®¾å®šå‡ åˆ†é’Ÿå†…æœ€ä½ä»·ä¹°å…¥åˆ™æ˜¾ç¤ºä¹°å…¥çš„æœ€é«˜ä»·ä¸ºå¤šå°‘
  def show_buy_period_max_price
    if get_invest_params(17,@code).to_i > 0
      return "ä¹°å…¥æœ€ä½ä»·æ—¶çš„æœ€é«˜ä»·ä¸ºï¼š#{get_invest_params(31,@code)}"
    end
  end

  # ä»¥ç¬¦å·è¡¨ç¤ºæˆæœ¬å‡ä»·æ˜¯å¦è¶Šä¹°è¶Šä½çš„åŠŸèƒ½å·²å¼€å¯
  def show_total_ave_cost_price
    # ç›®å‰çš„æˆæœ¬å‡ä»·
    ave_cost_price = @total_ave_cost_price
    ave_cost_price = ave_cost_price.floor(3) if ave_cost_price > 0
    # å‡ä»·åˆ°å¤šå°‘åˆ™åœæ­¢ä¹°å…¥
    @buy_limit_ave = get_invest_params(39,@code).to_i
    limit_msg = @buy_limit_ave > 0 ? "(å‡ä»·åˆ°è¾¾#{@buy_limit_ave}åˆ™åœæ­¢ä¹°å…¥)" : ""
    # å¦‚æœè²·å…¥ä¸‹ä¸€ç­†æˆæœ¬å‡åƒ¹å°‡å¤§æ–¼ä¸Šé™å‰‡ä»¥é«˜äº®é¡¯ç¤º(æ²¡æœ‰è®°å½•æ—¶ä¼šæœ‰Bugæš‚æ—¶å…³é—­æ­¤åŠŸèƒ½ 2022.4.29)
    span_class = reach_buy_limit_ave ? "buy_limit_ave" : ""
    get_invest_params(32,@code) == '1' ? raw("<u class=\"#{span_class}\" title=\"æˆäº¤å‡ä»·(æˆæœ¬å‡ä»·è¶Šä¹°è¶Šä½çš„åŠŸèƒ½å·²å¼€å¯)\">#{ave_cost_price}</u>") : raw("<span class=\"#{span_class}\" title=\"æˆäº¤å‡ä»·(å«æ‰‹ç»­è´¹)#{limit_msg}\">#{ave_cost_price}</span>")
  end

  # åˆ¤æ–­è²·å…¥ä¸‹ä¸€ç­†æˆæœ¬å‡åƒ¹æ˜¯å¦å°‡å¤§æ–¼ä¸Šé™(äº§ç”ŸBUGè€ŒåºŸå¼ƒä¸ç”¨)
  def reach_buy_limit_ave
    return false
  end

  # æ˜¾ç¤ºé¢åº¦ç¿»å€çš„æœ€å¤§è´­ä¹°ä»·
  def show_double_buy_top_price
    raw "<span title=\"é¢åº¦ç¿»å€çš„æœ€å¤§è´­ä¹°ä»·, æ¯éš”#{get_invest_params(33,@code)}ç‚¹è´­ä¹°é¢åº¦ç¿»å€\">#{get_invest_params(34,@code)}</span>"
  end
%>
<table width="<%=$default_table_width%>" style="font-size:<%=$deal_record_font_size%>">
  <tr class="thead">
    <td width="15"><%= link_to 'ğŸ ', set_crypto_as_home_path(code:@code) %></td>
    <td width="300">
      <% # æ˜¾ç¤ºä¹°å…¥ç­–ç•¥æ–‡å­— %>
      ğŸ“ˆ <%= show_buy_strategy(@code,3) %>
    </td>
    <td>
      <% # æˆäº¤ä»· %>
      <%= link_to t(:deal_record_price), order_list_params('price') %>
    </td>
    <td>æˆæœ¬</td>
    <td>
      <% # ç°å€¼ %>
      <%= t(:now_to_cny) %>
    </td>
    <td width="45">
      <% # ç›ˆäº %>
      <%= t(:earn_or_loss) %>
    </td>
    <td width="45">
      <% # åˆ©ç‡ %>
      <%= t(:profit_p) %>
    </td>
    <td>
      <% # æˆäº¤é‡ %>
      <%= link_to t(:deal_record_amount), order_list_params('amount') %>
    </td>
    <td colspan="2">
      <% # èµ„äº§å‡€å€¼å˜åŒ–å€¼ %>
      <%= show_net_value_change_text %>
    </td>
  </tr>
<% if @deal_records %>
<% @deal_records.each do |dr| %>
  <% if n <= $deal_records_limit or show_all_records_conditions %>
    <tr <%= change_row_color %>>
      <td align="right">
        <% # æ˜¾ç¤ºä¼˜å–åŠŸèƒ½é“¾æ¥ %>
        <span <%= raw "class='switch_first_sell'" if dr.first_sell %>>
          <%= link_to n, build_switch_params(:switch_first_sell, dr) %>
        </span>
      </td>
      <td align="center">
        <% # æ˜¾ç¤ºä¸‹å•æ—¶é—´ %>
        <%= link_edit_to(dr,to_t(dr.created_at,true)) %>
      </td>
      <td align="right">
        <% # æˆäº¤ä»· %>
        <%= price = to_n(dr.price,3) %>
      </td>
      <td align="right">
        <% # å€¼äººæ°‘å¸ %>
        <%= cny_amount = to_n(dr.cny_amount,1) %>
      </td>
      <td align="right">
        <% # ç°å€¼ %>
        <%= cny_amount_now = cal_with_crypto_now?(dr) ? \
        to_n(dr.cny_amount_now,1) : to_n(cny_amount.to_f + dr.real_profit.to_f,1) %>
      </td>
      <td align="right">
        <% # ç›ˆäº %>
        <%= earn_or_loss = dr.earn_or_loss if cal_with_crypto_now?(dr) %>
      </td>
      <td align="right">
        <% # åˆ©ç‡ %>
        <%= profit = to_n(earn_or_loss.to_f/cny_amount.to_f*100) if cal_with_crypto_now?(dr) %>
      </td>
      <td align="right">
        <% # æˆäº¤é‡ %>
        <% amount_fee = to_n(dr.amount-dr.fees,8) %>
        <%= amount = to_n(dr.amount,8) %>
      </td>
      <td align="right">
        <% # æ›´æ–°æ—¶é—´ %>
        <%= updated_at_str = to_time(dr.updated_at) %>
      </td>
      <td align="right">
        <%
          # æ­¤è¡¨æ ¼æ ä½ä¸ºåŠŸèƒ½é“¾æ¥æˆ–è€…æ˜¾ç¤ºè·åˆ©å€¼
          # å–å‡ºè®°å½•ï½œæ¶ˆè´¦è®°å½•ï½œé’±åŒ…è®°å½•
          if dr.auto_sell and dr.real_profit
            # è‹¥æ­¤è®°å½•ä¸ºé’±åŒ…è®°å½•
            if dr.real_profit == 0
              # è½¬åˆ°æœªå–è®°å½•  %>
              <%= link_to t(:set_from_trezor), build_switch_params(:switch_to_trezor,dr) %>
              <% # æœ¬è¡¨å…¨è½¬å‡º %>
              | <%= link_to t(:all_to_trezor), action: :auto_send_trezor_count %>
        <%  # è‹¥æ­¤è®°å½•ä¸ºæ¶ˆè´¦è®°å½•
            elsif dr.real_profit == 0.01
              # è½¬åˆ°æœªå–è®°å½•  %>
              <%= link_to t(:switch_from_balance), build_switch_params(:switch_to_balance,dr) %>
        <%  # è‹¥æ­¤è®°å½•ä¸ºå–å‡ºè®°å½•
            else
              # å·²å®ç°æŸç›Š(äººæ°‘å¸)
              real_profit = to_n(dr.real_profit,2)
              # å·²å®ç°æŸç›Š(CRYPTO)
              real_profit_crypto = to_n(real_profit.to_f*cny_to_crypto,8)
              # å¯Ÿçœ‹è®¢å•æˆäº¤æ˜ç»†  %>
              <%= look_order_link( dr, real_profit+' '+real_profit_crypto ) %>
        <%  end
          # æœªå–è®°å½•ï½œå‡‘æ¶ˆå¸ï½œå‡‘é’±åŒ…
          else
               # è½¬å‡ºåˆ°é’±åŒ…  %>
               <%#= link_to t(:set_to_trezor), build_switch_params(:switch_to_trezor,dr) %>
            <% # è½¬åˆ°æ¶ˆå¸è®°å½• %>
            <%#= link_to t(:switch_to_balance), build_switch_params(:switch_to_balance,dr) %>
        <%  # è‹¥æ­¤è®°å½•ä¸ºå‡‘é’±åŒ…è®°å½• %>
        <%  if params[:make_trezor_count] %>
            <% # æœ¬è¡¨å…¨è½¬å‡º %>
            <%= link_to t(:all_to_trezor), action: :auto_send_trezor_count %>
        <%  end %>
        <%  # è‹¥æ­¤è®°å½•ä¸ºå‡‘æ¶ˆå¸è®°å½• %>
        <%  if params[:make_balance_count] %>
            <% # æœ¬è¡¨å…¨æ¶ˆå¸ %>
            <%= link_to t(:all_to_balance), action: :auto_send_balance_count %>
        <%  end
          end %>
      </td>
    </tr>
  <%
    # ä»¥ä¸‹æ˜¯åªè®¡ç®—æ•°å€¼è€Œä¸æ˜¾ç¤ºåœ¨é¡µé¢çš„æ•°æ®è®°å½•
    else
      price = to_n(dr.price)
      amount = to_n(dr.amount,6)
      if dr.real_profit
        real_profit = to_n(dr.real_profit,2)
        real_profit_crypto = to_n(real_profit.to_f*cny_to_crypto,8)
      else
        cny_amount = to_n(dr.cny_amount,2)
        cny_amount_now = dr.cny_amount_now
        earn_or_loss = dr.earn_or_loss
        profit = to_n(earn_or_loss.to_f/cny_amount.to_f*100)
      end
    end
    # æ±‚å’Œä»¥æ˜¾ç¤ºæ•°æ®åŠ æ€»æˆ–æ±‚å¹³å‡
    n += 1
    total_price += price.to_f * amount.to_f
    total_amount += amount.to_f
    total_amount_fee += dr.amount_fees
    total_cny_amount += cny_amount.to_f
    total_cny_amount_now += cny_amount_now.to_f
    total_earn_or_loss += earn_or_loss.to_f
    if dr.real_profit
      total_real_profit += real_profit.to_f
      total_real_profit_crypto += real_profit_crypto.to_f
    end
    # æ‰¾å‡ºæˆäº¤ä»·çš„æœ€å¤§å€¼
    max_buy_price = dr.price if dr.price >= max_buy_price
  end # ç»“æŸ @deal_records.each
  # æˆäº¤å‡ä»·
  @total_ave_cost_price = total_amount > 0 ? (total_price/total_amount_fee).floor(4) : 0
%>
<% end %>
  <tr class="thead">
    <td colspan="2">
      <% # æ˜¾ç¤ºç°ä»·ä¸kçº¿å›¾é“¾æ¥ %>
      <%= show_prices_and_chart_links %>
    </td>
    <td align="right" title="é¢åº¦ç¿»å€çš„æœ€å¤§è´­ä¹°ä»·: <%= get_invest_params(34,@code) %>">
      <% # æ˜¾ç¤ºæˆäº¤å‡ä»· %>
      <%= show_total_ave_cost_price %>
    </td>
    <td align="right">
      <% # æ˜¾ç¤ºæˆæœ¬æ€»å’Œ %>
      <%= to_n(total_cny_amount,1) %>
    </td>
    <td align="right">
      <% # æ˜¾ç¤ºç°å€¼æ€»å’Œ %>
      <%= to_n(total_cny_amount_now,1) %>
    </td>
    <td align="right">
      <% # æ˜¾ç¤ºç›ˆäºæ€»å’Œ %>
      <%= to_n(total_earn_or_loss,2) %>
    </td>
    <td align="right">
      <% # æ˜¾ç¤ºåˆ©ç‡æ€»å’Œ %>
      <%= to_n(total_earn_or_loss.to_f/total_cny_amount.to_f*100,2) if total_cny_amount > 0 %>
    </td>
    <td align="right">
      <%
        # è®¡ç®—äº¤æ˜“æ‰€æ˜¯å¦æœ‰è¶³å¤Ÿçš„é‡ä»¥å–å‡ºä¸‹ä¸€ç¬”è®°å½•
        amount_remain_if_sell = @crypto_amount_ex - next_sell_amount
        # è®¡ç®—äº¤æ˜“æ‰€æ˜¯å¦æœ‰è¶³å¤Ÿçš„é‡ä»¥å–å‡ºæ‰€æœ‰è®°å½•
        amount_remain_if_clear = @crypto_amount_ex - total_amount_fee
        # æ˜¯å¦æ˜¾ç¤º8ä½çš„CRYPTOæ•°é‡
        if show_long_crypto_amount %>
          <%= to_n(total_amount,8) %>
      <%
        else
      %>
          <% # æ˜¾ç¤ºCRYPTOæ€»å’Œ %>
          <span title="äº¤æ˜“æ‰€çš„<%= @code.upcase %>æ€»æ•°"><%="#{to_n(@crypto_amount_ex,4)}"%></span>
      <%
        end
        # æ˜¾ç¤ºCRYPTOä»“ä½ç°å†µ %>
      | <span title="äº¤æ˜“æ‰€çš„<%= @code.upcase %>ä»“ä½"><%= to_n(@crypto_level,1) %></span>/<span title="è‡ªåŠ¨ä¹°å…¥çš„æœ€å¤§ä»“ä½å€¼"><%= to_n(@max_buy_level,1) %></span>(<span title="å†ä¹°å¤šå°‘å°±è¾¾åˆ°è‡ªåŠ¨ä¹°å…¥çš„æœ€å¤§ä»“ä½å€¼"><%=@max_buy_cny_remain.to_i%></span>/<span title="äº¤æ˜“æ‰€å†…å‰©ä½™çš„æ³°è¾¾å¸åˆäººæ°‘å¸çš„å€¼"><%= @usdt2cny_ex.to_i %></span>)
    </td>
    <td align="right" colspan="2">
      <% # æ˜¾ç¤ºèµ„äº§å‡€å€¼ä¸èµ°åŠ¿å›¾é“¾æ¥ %>
      <%= show_net_value_link %>
    </td>
  </tr>
</table>
