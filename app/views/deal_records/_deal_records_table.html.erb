<%
  # åˆå§‹åŒ–æ‰€æœ‰å˜é‡
  n = 1 # æ•°æ®é›†ç´¢å¼•åˆå§‹å€¼
  amount_pos = 8 # é»˜è®¤çš„æ¯”ç‰¹å¸æ€»å’Œæ˜¾ç¤ºä½æ•°
  total_price = total_amount = total_amount_fee = total_cny_amount = \
  total_cny_amount_now = total_earn_or_loss = total_real_profit = \
  total_real_profit_btc = max_buy_price = 0

  # æ¯”ç‰¹å¸ç°ä»·
  price_now = get_btc_price
  # ä»¥å¤ªåŠç°ä»·
  eth_now = get_eth_price
  # åŸæœ‰å‚ä¸æŠ•èµ„çš„æ³°è¾¾å¸
  @ori_usdt = get_invest_params(3).to_f
  # è‡ªåŠ¨ä¹°å…¥çš„æœ€å¤§ä»“ä½å€¼
  @max_buy_level = get_invest_params(5).to_f
  # è‡ªåŠ¨ä¹°å…¥çš„æœ€å¤§ä»“ä½å€¼åˆäººæ°‘å¸
  @max_buy_cny = @ori_usdt*@max_buy_level/100*$usdt_to_cny
  # äº¤æ˜“æ‰€å†…å‰©ä½™çš„æ¯”ç‰¹å¸
  @btc_amount_ex = DealRecord.btc_amount
  # äº¤æ˜“æ‰€å†…å‰©ä½™çš„æ³°è¾¾å¸çš„äººæ°‘å¸ä»·å€¼
  @usdt2cny_ex = DealRecord.usdt_amount*$usdt_to_cny
  # äººæ°‘å¸å…‘æ¢æ¯”ç‰¹å¸
  cny_to_btc = Currency.new.cny_to_btc
  # ä¸‹ä¸€ç¬”è¦å–å‡ºçš„æ¯”ç‰¹å¸æ•°é‡
  next_sell_amount = DealRecord.top_n_profit(@get_max_sell_count,:amount_fees)
  # æœ€è¿‘å‡ å°æ—¶å†…çš„ç´¯è®¡è·åˆ©
  real_profit_of_24h = DealRecord.real_profit_of_24h($send_to_trezor_time).to_i
  # æ€»ç´¯è®¡è·åˆ©
  total_real_profit = DealRecord.total_real_profit.to_i
  # å¹³å‡æ¯ç§’çš„å·²å®ç°æŸç›Šå€¼
  real_p_sec = DealRecord.real_profit_ave_sec($send_to_trezor_time)
  # æ˜¯å¦å·²ç»è¾¾åˆ°å¯ä»¥å†æ¬¡ä¹°å…¥çš„æ—¶é—´
  enable_to_buy = DealRecord.enable_to_buy?

  # æœ‰ä¼ å…¥ä»¥ä¸‹å‚æ•°è€…æ˜¾ç¤ºæ‰€æœ‰è®°å½•
  def show_all_records_conditions
    params[:show_all] or params[:show_sell] or params[:show_unsell] or \
    params[:show_first] or params[:show_trezor] or params[:make_balance_count] or \
    params[:make_trezor_count] or params[:show_balance]
  end

  # æœ‰ä¼ å…¥ä»¥ä¸‹å‚æ•°è€…æ˜¾ç¤º8ä½çš„æ¯”ç‰¹å¸æ•°é‡
  def show_long_btc_amount
    params[:make_trezor_count] or params[:show_trezor] or params[:show_unsell] or \
    params[:make_balance_count] or params[:show_balance]
  end

  # ç°ä»·æ ä½æ˜¯å¦æŒ‰ç…§æ¯”ç‰¹å¸ç°ä»·æ¥æ‰§è¡Œè®¡ç®—
  def cal_with_price_now?( dr )
    !dr.real_profit or dr.real_profit == 0
  end

  # åˆ—è¡¨ç§ç±»å‚æ•°
  def list_page_params
    {
      show_all: params[:show_all], show_sell: params[:show_sell], \
      show_unsell: params[:show_unsell], make_balance_count: params[:make_balance_count], \
      make_trezor_count: params[:make_trezor_count], show_first: params[:show_first], \
      show_balance: params[:show_balance], show_trezor: params[:show_trezor]
    }
  end

  # å¤šç§åˆ—è¡¨èƒ½é€‰æ‹©æŒ‰ç…§ä¸‹å•æ—¶é—´æˆäº¤ä»·æˆäº¤é‡æ’åº
  def order_list_params( field_name )
    { order_field: field_name }.merge list_page_params
  end

  # ç‚¹å‡»è½¬å‡ºåå¼€å¯æ–°è§†çª—
  def build_switch_params( action, id )
      { action: action, id: id }.merge list_page_params
  end

  # è‹¥æœ‰è®¾å®šå‡ åˆ†é’Ÿå†…æœ€ä½ä»·ä¹°å…¥åˆ™æ˜¾ç¤ºä¹°å…¥çš„æœ€é«˜ä»·ä¸ºå¤šå°‘
  def show_buy_period_max_price
    if get_invest_params(17).to_i > 0
      return "ä¹°å…¥æœ€ä½ä»·æ—¶çš„æœ€é«˜ä»·ä¸ºï¼š#{get_invest_params(31)}"
    end
  end

  # æ˜¾ç¤ºå½“å‰çš„ä¹°è¿›ç­–ç•¥
  def show_buy_strategy
    every_minute = get_invest_params(0).to_i/60
    buy_under_price = get_invest_params(1).to_i
    buy_when_minutes = get_invest_params(17).to_i
    buy_period_max_price = get_invest_params(31).to_i
    max_price_str = buy_period_max_price > 0 ? "|<span title=\"ä¹°å…¥æœ€ä½ä»·æ—¶çš„æœ€é«˜ä»·\">#{buy_period_max_price}</span>" : ""
    result = "ä½äº#{buy_under_price}|#{every_minute}åˆ†" if buy_under_price > 0
    result = "#{buy_when_minutes}ä½|#{every_minute}åˆ†#{max_price_str}" if buy_when_minutes > 0
    result = "<u>#{result}</u>" if DealRecord.enable_to_buy?
    return raw(result)
  end

  # ä»¥ç¬¦å·è¡¨ç¤ºæˆæœ¬å‡ä»·æ˜¯å¦è¶Šä¹°è¶Šä½çš„åŠŸèƒ½å·²å¼€å¯
  def show_total_ave_cost_price
    # ç›®å‰çš„æˆæœ¬å‡ä»·
    ave_cost_price = @total_ave_cost_price
    # å‡ä»·åˆ°å¤šå°‘åˆ™åœæ­¢ä¹°å…¥
    @buy_limit_ave = get_invest_params(39).to_i
    limit_msg = @buy_limit_ave > 0 ? "(å‡ä»·åˆ°è¾¾#{@buy_limit_ave}åˆ™åœæ­¢ä¹°å…¥)" : ""
    # å¦‚æœè²·å…¥ä¸‹ä¸€ç­†æˆæœ¬å‡åƒ¹å°‡å¤§æ–¼ä¸Šé™å‰‡ä»¥é«˜äº®é¡¯ç¤º
    span_class = reach_buy_limit_ave ? "buy_limit_ave" : ""
    get_invest_params(32) == '1' ? raw("<u class=\"#{span_class}\" title=\"æˆäº¤å‡ä»·(æˆæœ¬å‡ä»·è¶Šä¹°è¶Šä½çš„åŠŸèƒ½å·²å¼€å¯)\">#{ave_cost_price.to_i}</u>") : raw("<span class=\"#{span_class}\" title=\"æˆäº¤å‡ä»·#{limit_msg}\">#{ave_cost_price.to_i}</span>")
  end

  # åˆ¤æ–­è²·å…¥ä¸‹ä¸€ç­†æˆæœ¬å‡åƒ¹æ˜¯å¦å°‡å¤§æ–¼ä¸Šé™
  def reach_buy_limit_ave
    return true if @buy_limit_ave != 0 and @total_ave_cost_price.to_i >= @buy_limit_ave
    unsells = DealRecord.unsell_records
    if unsells.size > 0
      sum_cost = sum_amount = 0
      new_price = unsells[-1].price
      new_amount = unsells[-1].amount
      sum_cost = @total_ave_cost_price*@btc_amount_ex + new_price*new_amount
      sum_amount = @btc_amount_ex + new_amount
      cost_ave = (sum_cost/sum_amount).ceil(0)
      if @buy_limit_ave > 0 and cost_ave >= @buy_limit_ave
        return true
      else
        return false
      end
    else
      return false
    end
  end

  # æ˜¾ç¤ºé¢åº¦ç¿»å€çš„æœ€å¤§è´­ä¹°ä»·
  def show_double_buy_top_price
    raw "<span title=\"é¢åº¦ç¿»å€çš„æœ€å¤§è´­ä¹°ä»·, æ¯éš”#{get_invest_params(33)}ç‚¹è´­ä¹°é¢åº¦ç¿»å€\">#{get_invest_params(34)}</span>"
  end
%>
<table width="<%=$default_table_width%>">
  <tr class="thead">
    <td width="15"><%= link_to 'ğŸ ', set_btc_as_home_path %></td>
    <td width="280">
      <% # ä¸‹å•æ—¶é—´ %>
      <%= link_to t(:deal_record_created), order_list_params('created_at') %>
    </td>
    <td>
      <% # æˆäº¤ä»· %>
      <%= link_to t(:deal_record_price), order_list_params('price') %>
    </td>
    <td>
      <% # å€¼äººæ°‘å¸ %>
      <%= t(:exchange_to_cny) %>
    </td>
    <td>
      <% # ç°å€¼ %>
      <%= t(:now_to_cny) %>
    </td>
    <td width="45">
      <% # ç›ˆäº %>
      <%= t(:earn_or_loss) %>
    </td>
    <td width="45">
      <% # åˆ©ç‡ %>
      <%= t(:profit_p) %>
    </td>
    <td>
      <% # æˆäº¤é‡ %>
      <%= link_to t(:deal_record_amount), order_list_params('amount') %>
    </td>
    <td colspan="2">
      <% # æ›´æ–°æ—¶é—´ %>
      <%= link_to t(:updated_time), order_list_params('updated_at') %> |
      <% # èµ„äº§å‡€å€¼å˜åŒ–å€¼ %>
      <%= show_net_value_change_text %>
    </td>
  </tr>
<% @deal_records.each do |dr| %>
  <% if n <= $deal_records_limit or show_all_records_conditions %>
    <tr <%= change_row_color %>>
      <td align="right">
        <% # æ˜¾ç¤ºä¼˜å–åŠŸèƒ½é“¾æ¥ %>
        <span <%= raw "class='switch_first_sell'" if dr.first_sell %>>
          <%= link_to n, build_switch_params(:switch_first_sell, dr) %>
        </span>
      </td>
      <td align="center">
        <% # æ˜¾ç¤ºä¸‹å•æ—¶é—´ %>
        <%= link_edit_to(dr,to_t(dr.created_at,true)) %>
      </td>
      <td align="right">
        <% # æˆäº¤ä»· %>
        <%= price = to_n(dr.price) %>
      </td>
      <td align="right">
        <% # å€¼äººæ°‘å¸ %>
        <%= cny_amount = to_n(dr.cny_amount,1) %>
      </td>
      <td align="right">
        <% # ç°å€¼ %>
        <%= cny_amount_now = cal_with_price_now?(dr) ? \
        to_n(dr.cny_amount_now,1) : to_n(cny_amount.to_f + dr.real_profit.to_f,1) %>
      </td>
      <td align="right">
        <% # ç›ˆäº %>
        <%= earn_or_loss = dr.earn_or_loss if cal_with_price_now?(dr) %>
      </td>
      <td align="right">
        <% # åˆ©ç‡ %>
        <%= profit = to_n(earn_or_loss.to_f/cny_amount.to_f*100) if cal_with_price_now?(dr) %>
      </td>
      <td align="right">
        <% # æˆäº¤é‡ %>
        <% amount_fee = to_n(dr.amount-dr.fees,8) %>
        <%= amount = to_n(dr.amount,8) %>
      </td>
      <td align="right">
        <% # æ›´æ–°æ—¶é—´ %>
        <%= updated_at_str = to_time(dr.updated_at) %>
      </td>
      <td align="right">
        <%
          # æ­¤è¡¨æ ¼æ ä½ä¸ºåŠŸèƒ½é“¾æ¥æˆ–è€…æ˜¾ç¤ºè·åˆ©å€¼
          # å–å‡ºè®°å½•ï½œæ¶ˆè´¦è®°å½•ï½œé’±åŒ…è®°å½•
          if dr.auto_sell and dr.real_profit
            # è‹¥æ­¤è®°å½•ä¸ºé’±åŒ…è®°å½•
            if dr.real_profit == 0
              # è½¬åˆ°æœªå–è®°å½•  %>
              <%= link_to t(:set_from_trezor), build_switch_params(:switch_to_trezor,dr) %>
              <% # æœ¬è¡¨å…¨è½¬å‡º %>
              | <%= link_to t(:all_to_trezor), action: :auto_send_trezor_count %>
        <%  # è‹¥æ­¤è®°å½•ä¸ºæ¶ˆè´¦è®°å½•
            elsif dr.real_profit == 0.01
              # è½¬åˆ°æœªå–è®°å½•  %>
              <%= link_to t(:switch_from_balance), build_switch_params(:switch_to_balance,dr) %>
        <%  # è‹¥æ­¤è®°å½•ä¸ºå–å‡ºè®°å½•
            else
              # å·²å®ç°æŸç›Š(äººæ°‘å¸)
              real_profit = to_n(dr.real_profit,2)
              # å·²å®ç°æŸç›Š(æ¯”ç‰¹å¸)
              real_profit_btc = to_n(real_profit.to_f*cny_to_btc,8)
              # å¯Ÿçœ‹è®¢å•æˆäº¤æ˜ç»†  %>
              <%= look_order_link( dr, real_profit+' '+real_profit_btc ) %>
        <%  end
          # æœªå–è®°å½•ï½œå‡‘æ¶ˆå¸ï½œå‡‘é’±åŒ…
          else
               # è½¬å‡ºåˆ°é’±åŒ…  %>
               <%= link_to t(:set_to_trezor), build_switch_params(:switch_to_trezor,dr) %> |
            <% # è½¬åˆ°æ¶ˆå¸è®°å½• %>
            <%= link_to t(:switch_to_balance), build_switch_params(:switch_to_balance,dr) %>
        <%  # è‹¥æ­¤è®°å½•ä¸ºå‡‘é’±åŒ…è®°å½• %>
        <%  if params[:make_trezor_count] %>
            <% # æœ¬è¡¨å…¨è½¬å‡º %>
            | <%= link_to t(:all_to_trezor), action: :auto_send_trezor_count %>
        <%  end %>
        <%  # è‹¥æ­¤è®°å½•ä¸ºå‡‘æ¶ˆå¸è®°å½• %>
        <%  if params[:make_balance_count] %>
            <% # æœ¬è¡¨å…¨æ¶ˆå¸ %>
            | <%= link_to t(:all_to_balance), action: :auto_send_balance_count %>
        <%  end
          end %>
      </td>
    </tr>
  <%
    # ä»¥ä¸‹æ˜¯åªè®¡ç®—æ•°å€¼è€Œä¸æ˜¾ç¤ºåœ¨é¡µé¢çš„æ•°æ®è®°å½•
    else
      price = to_n(dr.price)
      amount = to_n(dr.amount,6)
      if dr.real_profit
        real_profit = to_n(dr.real_profit,2)
        real_profit_btc = to_n(real_profit.to_f*cny_to_btc,8)
      else
        cny_amount = to_n(dr.cny_amount,2)
        cny_amount_now = dr.cny_amount_now
        earn_or_loss = dr.earn_or_loss
        profit = to_n(earn_or_loss.to_f/cny_amount.to_f*100)
      end
    end
    # æ±‚å’Œä»¥æ˜¾ç¤ºæ•°æ®åŠ æ€»æˆ–æ±‚å¹³å‡
    n += 1
    total_price += price.to_f * amount.to_f
    total_amount += amount.to_f
    total_amount_fee += dr.amount_fees
    total_cny_amount += cny_amount.to_f
    total_cny_amount_now += cny_amount_now.to_f
    total_earn_or_loss += earn_or_loss.to_f
    if dr.real_profit
      total_real_profit += real_profit.to_f
      total_real_profit_btc += real_profit_btc.to_f
    end
    # æ‰¾å‡ºæˆäº¤ä»·çš„æœ€å¤§å€¼
    max_buy_price = dr.price if dr.price >= max_buy_price
  end # ç»“æŸ @deal_records.each
  # æˆäº¤å‡ä»·
  @total_ave_cost_price = total_amount > 0 ? (total_price/total_amount_fee).floor(4) : ''
%>
  <tr class="thead">
    <td colspan="2">
      <% # æ˜¾ç¤ºç°ä»·ä¸kçº¿å›¾é“¾æ¥ %>
      <%= kline_chart_link(to_n(price_now,2)) %> | <%= kline_chart_link to_n(@eth_price), "ethusdt" %>
      <% # æ˜¾ç¤ºä¹°å…¥ç­–ç•¥æ–‡å­— %>
      <%= show_buy_strategy %>
    </td>
    <td align="right">
      <% # æ˜¾ç¤ºæˆäº¤å‡ä»·|é¢åº¦ç¿»å€çš„æœ€å¤§è´­ä¹°ä»· %>
      <%= show_total_ave_cost_price %> | <%= show_double_buy_top_price %>
    </td>
    <td align="right">
      <% # æ˜¾ç¤ºæˆæœ¬æ€»å’Œ %>
      <%= to_n(total_cny_amount,0) %>
    </td>
    <td align="right">
      <% # æ˜¾ç¤ºç°å€¼æ€»å’Œ %>
      <%= to_n(total_cny_amount_now,0) %>
    </td>
    <td align="right">
      <% # æ˜¾ç¤ºç›ˆäºæ€»å’Œ %>
      <%= to_n(total_earn_or_loss,1) %>
    </td>
    <td align="right">
      <% # æ˜¾ç¤ºåˆ©ç‡æ€»å’Œ %>
      <%= to_n(total_earn_or_loss.to_f/total_cny_amount.to_f*100) if total_cny_amount > 0 %>
    </td>
    <td align="right">
      <%
        # è®¡ç®—äº¤æ˜“æ‰€æ˜¯å¦æœ‰è¶³å¤Ÿçš„é‡ä»¥å–å‡ºä¸‹ä¸€ç¬”è®°å½•
        amount_remain_if_sell = @btc_amount_ex - next_sell_amount
        # è®¡ç®—äº¤æ˜“æ‰€æ˜¯å¦æœ‰è¶³å¤Ÿçš„é‡ä»¥å–å‡ºæ‰€æœ‰è®°å½•
        amount_remain_if_clear = @btc_amount_ex - total_amount_fee
        # æ˜¯å¦æ˜¾ç¤º8ä½çš„æ¯”ç‰¹å¸æ•°é‡
        if show_long_btc_amount %>
          <%= to_n(total_amount,8) %>
      <%
        else
      %>
          <% # æ˜¾ç¤ºæ¯”ç‰¹å¸æ€»å’Œ %>
          <%= link_to "#{to_n(total_amount_fee,amount_pos)}/#{to_n(@btc_amount_ex,amount_pos)}",\
          place_order_form_path(amount:to_n(@btc_amount_ex,6)), \
          title: "#{to_n(total_amount_fee,8)}/#{to_n(next_sell_amount,8)}/#{to_n(@btc_amount_ex,8)}\n å·®å€¼: #{to_n(amount_remain_if_sell,8)}(å–)|#{to_n(amount_remain_if_clear,8)}(æ€»)" %>
      <%
        end
      %>
      <% # æ˜¾ç¤ºæ¯”ç‰¹å¸ä»“ä½ç°å†µ %>
      | <%= to_n(DealRecord.btc_level,2) %>/<span title="è‡ªåŠ¨ä¹°å…¥çš„æœ€å¤§ä»“ä½å€¼"><%= @max_buy_level %>(Â¥<%=@max_buy_cny.to_i%>)</span>
      | <span title="äº¤æ˜“æ‰€å†…å‰©ä½™çš„æ³°è¾¾å¸åˆäººæ°‘å¸çš„å€¼">Â¥<%= @usdt2cny_ex.to_i %>å¯æŠ•</span>
    </td>
    <td align="right" colspan="2">
      <% # æ˜¾ç¤ºèµ„äº§å‡€å€¼ä¸èµ°åŠ¿å›¾é“¾æ¥ %>
      <%= show_net_value_link %>
      <% # æ˜¾ç¤ºå·²å®ç°æŸç›Šçš„å¹³å‡ç»©æ•ˆ %>
      | <span title="æ ¹æ®å·²å®ç°æŸç›Šé¢„ä¼°æ¯æœˆçš„è·åˆ©(Â¥)"><%= (real_p_sec*3600*24*30).to_i %></span>/æœˆ
    </td>
  </tr>
</table>
